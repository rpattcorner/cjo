<%


    # This deploy targets the VPC of the CAP master using env variable
    # needed: windows launch in vpc or entry there

        $admins = []
        ENV['ADMINS'].split(/\s+/).each { |admin|
                $admins << %Q(\t\t{\n\t\t\t"name":"#{admin}",\n\t\t\t"email":"#{admin}"\n\t\t})
        }
%>{
        "appname": "cjoasg",
        "server_pools": [
                {
                        "name": "cjo-pool",
                        "ssh_user": "ubuntu",
                        "min-size": 1,
                        "max-size": 1,
                        "wait_for_nodes":1,
                         "run_list": [
                                "recipe[cjo_site]" 
                        ],
                    "static_ip": {
                                "ip": "<%= $target_ip_lin %>",
                                "assign_ip": true
                                },
                                "zones": [
                                        "us-east-1c",
                                        "us-east-1d"
                                ],

                    "add_firewall_rules": [
                        {
                            "rule_name":"cjo-portal_secgroup"
                        }
                    ],


                    "vpc": {
                        "vpc_id": "<%= ENV['VPCID'] %>",
                        "subnets" : [
                            {"subnet_id": "<%= ENV['TARGET_PUBLIC_SUBNET'] %>"}
                        ]

                    },

                    "dependencies": [
                    {
                            "name": "cjo-db",
                            "type": "database"
                    }
                    ],

                    "basis": {
                            "launch-config": {
                                    "name": "cjo",
                                    <%= CAP::Config.include("webportal_ami.json") %>,
                                    "size": "t2.micro",
                                    "iam-role": "cjo_node_role"

                            }
                    }
                }
        ],

       "firewall_rules": [
            {
            "name":"database_secgroup",
            "vpc_id": "<%= ENV['VPCID'] %>",

                "rules": [
                    {
                        "port":3306,
                        "sgs": [
                            "cjo-portal_secgroup"
                        ]
                    }
                ]
            },


            {
            "name": "cjo-portal_secgroup",
            "vpc_id": "<%= ENV['VPCID'] %>",
            "rules": [
                    {
                        "port": 443,
                        "hosts": [
                            "0.0.0.0/0"
                        ]
                    },
                    {
                        "port": 80,
                        "hosts": [
                            "0.0.0.0/0"
                        ]
                    }
                ]
            }
        ],

        "databases": [
                {
                        "name": "cjo-db",
                        "engine": "mysql",
                        "creation_style": "existing_snapshot",
                        "identifier": "<%=$dbid%>",
                        "multi-az-on-deploy": false,
                        "size": "db.t2.micro",
                        "storage": 5,
                        "password": "<%=$dbpw%>",
                        "publicly_accessible" : false,
                        "vpc": {
                            "vpc_id": "<%= ENV['VPCID'] %>",
                            "subnets" : [
                                {"subnet_id": "<%= ENV['TARGET_PRIVATE_SUBNET_1'] %>"},
                                {"subnet_id": "<%= ENV['TARGET_PRIVATE_SUBNET_2'] %>"}
                            ]

                        },
                        "add_firewall_rules": [
                            {
                            "rule_name":"database_secgroup"
                            }
                        ]
                }
        ],
        "admins": [
            <%= $admins.join(",\n") %>
        ]
}